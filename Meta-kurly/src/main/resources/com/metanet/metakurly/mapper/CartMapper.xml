<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="com.metanet.metakurly.mapper.CartMapper">


	<!-- 해당 회원 장바구니 리스트 출력 -->
	<select id="getMyCartList"
		resultType="com.metanet.metakurly.domain.CartDTO"
		resultMap="cartMap">
		select c.p_id, c.quantity, c.total_price, p.name, p.price
		from cart c, product p
		where c.p_id = p.p_id
		and m_id = #{m_id}
	</select>
	
 	<resultMap type="com.metanet.metakurly.domain.CartDTO" id="cartMap">
	 	<result property="quantity" column="quantity"/>
	 	<result property="total_price" column="total_price"/>
	 	<collection property="priductList" resultMap="productMap">
	 	</collection>
	</resultMap>
	
	
	<resultMap type="com.metanet.metakurly.domain.ProductDTO" id="productMap">
	 	<result property="name" column="name"/>
	 	<result property="price" column="price"/>
	</resultMap>
	
	
	<!--  장바구니에 물건 추가 -->
	<insert id="addCart">
		insert into cart 
		values (#{m_id}, #{p_id}, #{quantity}, #{total_price})
	</insert>
	
	<!-- 장바구니 중복 상품 확인 -->
	<select id="checkCart" resultType="int">
		select count(*)
		from cart
		where p_id = #{p_id}
		and m_id = #{m_id}
	</select>
	
	<!-- 중복된 상품이 있다면 넣지말고 수량 더해주기 -->
	<update id="updateCount">
	 update cart c
	 set c.quantity = c.quantity + #{quantity},
	 c.total_price = (select p.price from product p where c.p_id = p.p_id and p.p_id = #{p_id})
	 where c.m_id = #{m_id}
	 and c.p_id = #{p_id}
	</update>
	
	<!-- 장바구니 물건 삭제 -->
	<delete id="deleteCart">
	 delete from cart 
	 where p_id = #{p_id}
	 and m_id = #{m_id}
	</delete>
	
	<!-- 장바구니 전체 비우기 -->
	<delete id="deleteAllCart">
	delete from cart
	where m_id = #{m_id}
	</delete>
	
	<!-- 장바구니 물건 업데이트 (장바구니에서 수량변경하는 것) -->
	<update id="updateCart" parameterType="com.metanet.metakurly.domain.CartDTO">
		update cart
		set quantity = #{quantity}
		where m_id = #{m_id}
		and p_id = #{p_id}
	</update>
	
	<!-- 해당 회원의 장바구니 전체 금액 출력 -->
	<select id="getTotalPrice" resultType="com.metanet.metakurly.domain.CartDTO">
		select nvl(sum(p.price * quantity), 0) as TOTAL_PRICE
		from cart c, product p
		where c.p_id = p.p_id
		and m_id = #{m_id}
	</select>


</mapper>